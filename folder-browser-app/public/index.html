<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Folder Browser</title>
  <style>
    body { font-family: Arial, sans-serif; }
    ul { list-style-type: none; padding: 0; }
    li { margin: 5px 0; }
    a { text-decoration: none; color: #007BFF; }
    a:hover { text-decoration: underline; }
    
    #videoModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    #videoContainer {
      position: relative;
      margin-left: 50px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #videoPlayer {
      width: 90%;
      max-width: 1200px;
    }

    #closeButton {
      position: absolute;
      top: -10px;
      right: -10px;
      background-color: #fff;
      border: none;
      font-size: 20px;
      cursor: pointer;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      line-height: 26px;
      text-align: center;
      padding: 0;
    }

    #speedControls {
      margin-top: 10px;
      text-align: center;
    }

    .speed-button {
      margin: 0 5px;
      padding: 5px 10px;
      font-size: 16px;
      cursor: pointer;
    }

    .pass-checkbox {
      margin-left: 10px;
      accent-color: green;
      width: 20px;
      height: 20px;
    }
    
    .wtc-checkbox {
      margin-left: 5px;
      accent-color: #90EE90;
      width: 20px;
      height: 20px;
    }
    
    .blue-square {
      display: inline-block;
      width: 10px;
      height: 10px;
      background-color: blue;
      margin-left: 5px;
    }
    
    .rating-bars {
      display: inline-flex;
      align-items: flex-end;
      margin-left: 5px;
      height: 16px;
      width: 20px;
      background-color: white;
      border-radius: 2px;
      padding: 1px;
    }
    
    .rating-bar {
      width: 4px;
      background-color: #333;
      margin-right: 1px;
    }
    
    .rating-bar.bar1 { height: 4px; }
    .rating-bar.bar2 { height: 8px; }
    .rating-bar.bar3 { height: 12px; }
    .rating-bar.bar4 { height: 16px; }
    
    .rating-bars.rating-3 .rating-bar {
      background-color: #32CD32;
      box-shadow: 0 0 4px #32CD32;
    }
    
    .rating-bars.rating-2 .rating-bar {
      background-color: #FFA500;
    }
    
    .rating-bars.rating-1 .rating-bar {
      background-color: #FF4444;
    }
    
    .rating-select {
      margin-left: 5px;
      font-size: 12px;
      width: 40px;
    }
  </style>
</head>
<body>
  <h1>Folder Browser</h1>
  <input type="text" size="100" id="folderPath" value="H:\Vidokursu_and_Books_From_118a\6.1JAVA_\03SpringFramework" placeholder="Enter folder path">
  <button onclick="loadFolder()">Load Folder</button>
  <ul id="fileList"></ul>

  <!-- Modal for video player -->
  <div id="videoModal">
    <div id="videoContainer">
      <button id="closeButton">‚úñ</button>
      <video id="videoPlayer" controls></video>
      <div id="speedControls">
        <button class="speed-button" data-speed="1">1x</button>
        <button class="speed-button" data-speed="1.5">1.5x</button>
        <button class="speed-button" data-speed="1.75">1.75x</button>
        <button class="speed-button" data-speed="2">2x</button>
        <button class="speed-button" data-speed="2.25">2.25x</button>
        <button class="speed-button" data-speed="2.5">2.5x</button>
        <button class="speed-button" data-speed="2.75">2.75x</button>
      </div>
    </div>
  </div>

  <!-- Background Audio Element for Motivational Music -->
  <audio id="backgroundAudio" loop style="display:none;">
    <source src="music/yt1znet-RodneySpence-LastOfTheTransports.mp3" type="audio/mp3">
    Your browser does not support the audio element.
  </audio>

  <script>
    // Array of music tracks. Adjust these paths to match your /music/ folder.
    const musicTracks = [
      "music/Alan Walker - Faded (Instrumental Version).mp3",
      "music/Intro.mp3",
      "music/M83 'We Own The Sky' Official video.mp3",
      "music/M83 - Midnight City (Instrumental).mp3",
      "music/yt1znet-RodneySpence-LastOfTheTransports.mp3"
    ];

    var currentPath = "";

    async function loadFolder(folderPath) {
      folderPath = folderPath || document.getElementById('folderPath').value;

      // Update the URL query parameter
      const url = new URL(window.location);
      url.searchParams.set('folder', folderPath);
      history.replaceState(null, '', url);

      currentPath = folderPath;
      // Replace backslashes with forward slashes.
      folderPath = folderPath.replace(/\\/g, '/');
      
      const response = await fetch(`/list?folder=${encodeURIComponent(folderPath)}`);
      const files = await response.json();
      
      const fileList = document.getElementById('fileList');
      fileList.innerHTML = '';

      // If not in root, add a "Go Up" entry
      const pathParts = folderPath.split('/');
      if (pathParts.length > 1) {
        const parentFolder = pathParts.slice(0, -1).join('/');
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = '#';
        a.textContent = '.. (Go Up)';
        a.addEventListener('click', function(event) {
          event.preventDefault();
          loadFolder(parentFolder);
        });
        li.appendChild(a);
        fileList.appendChild(li);
      }

      // List files/folders
      files.forEach(file => {
        const li = document.createElement('li');
        const filePath = file.path.replace(/\\/g, '/');

        if (file.isDirectory) {
          const a = document.createElement('a');
          a.href = '#';
          a.textContent = `üìÅ ${file.name}`;
          a.addEventListener('click', function(event) {
            event.preventDefault();
            loadFolder(filePath);
          });
          
          // Color styling - PASS overrides wtc
          if (file.name.toLowerCase().includes("-pass")) {
            li.style.backgroundColor = "lightgreen";
          } else if (file.name.toLowerCase().includes("-wtc")) {
            li.style.backgroundColor = "#E8F5E8";
          }
          
          if (file.name.toLowerCase().includes("react--")) { 
            li.style.fontWeight = "bold";
          }
          if (file.name.toLowerCase().includes("==app")) {
            li.style.textDecoration = "underline";
          }
          if (file.name.toLowerCase().includes("netflix")) {
            li.style.textDecorationLine = "underline"; 
            li.style.textDecorationStyle = "wavy";
          }
          li.appendChild(a);
          
          // Add checkboxes for folders
          const passLabel = document.createElement('span');
          passLabel.textContent = ' P:';
          passLabel.style.fontSize = '12px';
          passLabel.style.color = '#666';
          li.appendChild(passLabel);
          
          const passCheckbox = document.createElement('input');
          passCheckbox.type = 'checkbox';
          passCheckbox.className = 'pass-checkbox';
          passCheckbox.checked = file.name.toLowerCase().includes('-pass');
          passCheckbox.addEventListener('change', function() {
            if (this.checked) {
              markPass(filePath);
            }
          });
          li.appendChild(passCheckbox);
          
          const wtcLabel = document.createElement('span');
          wtcLabel.textContent = ' W:';
          wtcLabel.style.fontSize = '12px';
          wtcLabel.style.color = '#666';
          li.appendChild(wtcLabel);
          
          const wtcCheckbox = document.createElement('input');
          wtcCheckbox.type = 'checkbox';
          wtcCheckbox.className = 'wtc-checkbox';
          wtcCheckbox.checked = file.name.toLowerCase().includes('-wtc');
          wtcCheckbox.addEventListener('change', function() {
            if (this.checked) {
              markWtc(filePath);
            }
          });
          li.appendChild(wtcCheckbox);
          
          // Add rating system for folders
          const currentRating = extractRating(file.name);
          
          const ratingBars = createRatingBars(currentRating);
          li.appendChild(ratingBars);
          
          const ratingSelect = document.createElement('select');
          ratingSelect.className = 'rating-select';
          for (let i = 0; i <= 3; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = i;
            option.selected = (i === currentRating);
            ratingSelect.appendChild(option);
          }
          ratingSelect.addEventListener('change', function() {
            setRating(filePath, parseInt(this.value));
          });
          li.appendChild(ratingSelect);
        } else {
          const a = document.createElement('a');
          if (/\.(mp4|webm|ts|avi|mkv)$/i.test(file.name)) {
            a.href = '#';
            a.textContent = `üìÑ ${file.name}`;
            a.addEventListener('click', function(event) {
              event.preventDefault();
              playVideo(filePath);
            });
          } else {
            a.href = `${filePath}`;
            a.download = '';
            a.textContent = `üìÑ ${file.name}`;
          }
          li.appendChild(a);
          
          // Color styling - PASS overrides wtc
          if (file.name.toLowerCase().includes("-pass")) {
            li.style.backgroundColor = "lightgreen";
          } else if (file.name.toLowerCase().includes("-wtc")) {
            li.style.backgroundColor = "#E8F5E8";
          }

          if (file.name.toLowerCase().includes("-qq")) {
            li.style.backgroundColor = "lightgreen";
            const blueSquare = document.createElement("span");
            blueSquare.className = "blue-square";
            li.appendChild(blueSquare);
          }

          if (/\.(mp4|webm|ts|avi|mkv)$/i.test(file.name)) {
            const playButton = document.createElement('button');
            playButton.textContent = 'Play';
            playButton.addEventListener('click', function() {
              playVideo(filePath);
            });
            li.appendChild(playButton);

            const passLabel = document.createElement('span');
            passLabel.textContent = ' P:';
            passLabel.style.fontSize = '12px';
            passLabel.style.color = '#666';
            li.appendChild(passLabel);
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'pass-checkbox';
            checkbox.checked = file.name.toLowerCase().includes('-pass');
            checkbox.addEventListener('change', function() {
              if (this.checked) {
                markPass(filePath);
              }
            });
            li.appendChild(checkbox);
            
            const wtcLabel = document.createElement('span');
            wtcLabel.textContent = ' W:';
            wtcLabel.style.fontSize = '12px';
            wtcLabel.style.color = '#666';
            li.appendChild(wtcLabel);
            
            const wtcCheckbox = document.createElement('input');
            wtcCheckbox.type = 'checkbox';
            wtcCheckbox.className = 'wtc-checkbox';
            wtcCheckbox.checked = file.name.toLowerCase().includes('-wtc');
            wtcCheckbox.addEventListener('change', function() {
              if (this.checked) {
                markWtc(filePath);
              }
            });
            li.appendChild(wtcCheckbox);
          } 
          
          // Add rating system for ALL files (outside video conditional)
          const fileRating = extractRating(file.name);
          
          const fileRatingBars = createRatingBars(fileRating);
          li.appendChild(fileRatingBars);
          
          const fileRatingSelect = document.createElement('select');
          fileRatingSelect.className = 'rating-select';
          for (let i = 0; i <= 3; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = i;
            option.selected = (i === fileRating);
            fileRatingSelect.appendChild(option);
          }
          fileRatingSelect.addEventListener('change', function() {
            setRating(filePath, parseInt(this.value));
          });
          li.appendChild(fileRatingSelect);
        }
        fileList.appendChild(li);
      });
    }

    function playVideo(videoPath) {
      videoPath = videoPath.replace(/\\/g, '/');
      const videoPlayer = document.getElementById('videoPlayer');
      videoPlayer.src = `/video?path=${encodeURIComponent(videoPath)}`;
      document.getElementById('videoModal').style.display = 'flex';
      videoPlayer.play();
      videoPlayer.playbackRate = 2.5;

      // Pick a random track from the musicTracks array.
      const randomIndex = Math.floor(Math.random() * musicTracks.length);
      const randomTrack = musicTracks[randomIndex];

      // Set background audio to that random track and play.
      const bgAudio = document.getElementById('backgroundAudio');
      bgAudio.src = randomTrack;
      bgAudio.volume = 0.02;
      bgAudio.play();
    }

    async function markPass(filePath) {
      try {
        const response = await fetch('/markPass', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ filename: filePath }),
        });
        const result = await response.json();
        console.log(result.message);
        loadFolder(currentPath);
      } catch (error) {
        console.error('Error marking file as PASS:', error);
      }
    }
    
    async function markWtc(filePath) {
      try {
        const response = await fetch('/markWtc', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ filename: filePath }),
        });
        const result = await response.json();
        console.log(result.message);
        loadFolder(currentPath);
      } catch (error) {
        console.error('Error marking file as WTC:', error);
      }
    }
    
    function extractRating(filename) {
      const match = filename.match(/-r([0-3])/i);
      return match ? parseInt(match[1]) : 0;
    }
    
    function createRatingBars(rating) {
      const container = document.createElement('div');
      container.className = `rating-bars rating-${rating}`;
      
      for (let i = 1; i <= 4; i++) {
        const bar = document.createElement('div');
        bar.className = `rating-bar bar${i}`;
        if (i > rating) {
          bar.style.opacity = '0.2';
        }
        container.appendChild(bar);
      }
      
      return container;
    }
    
    async function setRating(filePath, rating) {
      try {
        const response = await fetch('/setRating', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ filename: filePath, rating: rating }),
        });
        const result = await response.json();
        console.log(result.message);
        loadFolder(currentPath);
      } catch (error) {
        console.error('Error setting rating:', error);
      }
    }

    document.getElementById('videoModal').addEventListener('click', function(event) {
      if (event.target === this) {
        closeVideo();
      }
    });

    document.getElementById('videoContainer').addEventListener('click', function(event) {
      event.stopPropagation();
    });

    document.getElementById('closeButton').addEventListener('click', closeVideo);

    function closeVideo() {
      const videoPlayer = document.getElementById('videoPlayer');
      videoPlayer.pause();
      videoPlayer.currentTime = 0;
      videoPlayer.src = '';
      document.getElementById('videoModal').style.display = 'none';

      const bgAudio = document.getElementById('backgroundAudio');
      bgAudio.pause();
      bgAudio.currentTime = 0;
    }

    document.querySelectorAll('.speed-button').forEach(function(button) {
      button.addEventListener('click', function() {
        const speed = parseFloat(this.dataset.speed);
        const videoPlayer = document.getElementById('videoPlayer');
        videoPlayer.playbackRate = speed;
        console.log(`Playback speed set to ${speed}x`);
      });
    });

    // When the page loads, check for a folder param in the URL.
    window.addEventListener('DOMContentLoaded', function() {
      const urlParams = new URLSearchParams(window.location.search);
      const folderParam = urlParams.get('folder');
      if (folderParam) {
        document.getElementById('folderPath').value = folderParam;
        loadFolder(folderParam);
      } else {
        loadFolder();
      }
    });
  </script>
</body>
</html>